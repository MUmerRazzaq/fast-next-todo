openapi: 3.0.3
info:
  title: ${API_TITLE}
  description: |
    ${API_DESCRIPTION}

    ## Authentication
    ${AUTH_DESCRIPTION}

    ## Rate Limiting
    ${RATE_LIMIT_DESCRIPTION}
  version: ${API_VERSION}
  contact:
    name: ${CONTACT_NAME}
    email: ${CONTACT_EMAIL}
  license:
    name: ${LICENSE_NAME}
    url: ${LICENSE_URL}

servers:
  - url: https://api.example.com/v1
    description: Production server
  - url: https://staging-api.example.com/v1
    description: Staging server
  - url: http://localhost:3000/v1
    description: Local development

tags:
  - name: Items
    description: Operations for managing items

paths:
  /items:
    get:
      tags:
        - Items
      summary: List all items
      description: Retrieves a paginated list of items with optional filtering and sorting.
      operationId: listItems
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/LimitParam'
        - $ref: '#/components/parameters/SortParam'
        - $ref: '#/components/parameters/FilterParam'
      responses:
        '200':
          description: Successful response with paginated items
          headers:
            X-Total-Count:
              $ref: '#/components/headers/X-Total-Count'
            X-Page:
              $ref: '#/components/headers/X-Page'
            X-Per-Page:
              $ref: '#/components/headers/X-Per-Page'
            Link:
              $ref: '#/components/headers/Link'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ItemListResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

    post:
      tags:
        - Items
      summary: Create a new item
      description: Creates a new item with the provided data.
      operationId: createItem
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ItemCreate'
      responses:
        '201':
          description: Item created successfully
          headers:
            Location:
              description: URL of the newly created resource
              schema:
                type: string
                format: uri
                example: /items/123
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Item'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '409':
          $ref: '#/components/responses/Conflict'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'
        '500':
          $ref: '#/components/responses/InternalError'

  /items/{itemId}:
    parameters:
      - $ref: '#/components/parameters/ItemIdParam'

    get:
      tags:
        - Items
      summary: Get item by ID
      description: Retrieves a specific item by its unique identifier.
      operationId: getItem
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Item'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

    put:
      tags:
        - Items
      summary: Replace an item
      description: Fully replaces an existing item. All fields must be provided.
      operationId: replaceItem
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ItemCreate'
      responses:
        '200':
          description: Item replaced successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Item'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'
        '500':
          $ref: '#/components/responses/InternalError'

    patch:
      tags:
        - Items
      summary: Update an item
      description: Partially updates an existing item. Only provided fields are updated.
      operationId: updateItem
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ItemUpdate'
      responses:
        '200':
          description: Item updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Item'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'
        '500':
          $ref: '#/components/responses/InternalError'

    delete:
      tags:
        - Items
      summary: Delete an item
      description: Permanently deletes an item by its ID.
      operationId: deleteItem
      responses:
        '204':
          description: Item deleted successfully (no content)
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /items/{itemId}/sub-resources:
    parameters:
      - $ref: '#/components/parameters/ItemIdParam'

    get:
      tags:
        - Items
      summary: List sub-resources of an item
      description: Retrieves all sub-resources belonging to a specific item.
      operationId: listItemSubResources
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubResourceListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token authentication

    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key authentication

    OAuth2:
      type: oauth2
      flows:
        authorizationCode:
          authorizationUrl: https://auth.example.com/oauth/authorize
          tokenUrl: https://auth.example.com/oauth/token
          scopes:
            read:items: Read access to items
            write:items: Write access to items
            delete:items: Delete items

  parameters:
    ItemIdParam:
      name: itemId
      in: path
      required: true
      description: Unique identifier of the item
      schema:
        type: string
        format: uuid
        example: 550e8400-e29b-41d4-a716-446655440000

    PageParam:
      name: page
      in: query
      description: Page number for pagination (1-indexed)
      schema:
        type: integer
        minimum: 1
        default: 1
        example: 1

    LimitParam:
      name: limit
      in: query
      description: Number of items per page
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20
        example: 20

    SortParam:
      name: sort
      in: query
      description: |
        Sort field and direction. Format: `field:direction`
        - `field` - The field name to sort by
        - `direction` - Either `asc` (ascending) or `desc` (descending)
        Multiple sorts can be comma-separated.
      schema:
        type: string
        example: createdAt:desc,name:asc

    FilterParam:
      name: filter
      in: query
      description: |
        Filter criteria in format: `field:operator:value`
        Operators: eq, ne, gt, gte, lt, lte, like, in
        Multiple filters can be comma-separated.
      schema:
        type: string
        example: status:eq:active,createdAt:gte:2024-01-01

  headers:
    X-Total-Count:
      description: Total number of items across all pages
      schema:
        type: integer
        example: 100

    X-Page:
      description: Current page number
      schema:
        type: integer
        example: 1

    X-Per-Page:
      description: Number of items per page
      schema:
        type: integer
        example: 20

    Link:
      description: RFC 5988 pagination links (first, prev, next, last)
      schema:
        type: string
        example: '</items?page=2>; rel="next", </items?page=5>; rel="last"'

    X-RateLimit-Limit:
      description: Maximum requests per time window
      schema:
        type: integer
        example: 1000

    X-RateLimit-Remaining:
      description: Remaining requests in current window
      schema:
        type: integer
        example: 999

    X-RateLimit-Reset:
      description: Unix timestamp when rate limit resets
      schema:
        type: integer
        example: 1609459200

  schemas:
    Item:
      type: object
      required:
        - id
        - name
        - status
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier
          readOnly: true
          example: 550e8400-e29b-41d4-a716-446655440000
        name:
          type: string
          minLength: 1
          maxLength: 255
          description: Name of the item
          example: My Item
        description:
          type: string
          maxLength: 2000
          nullable: true
          description: Optional description
          example: A detailed description of the item
        status:
          $ref: '#/components/schemas/ItemStatus'
        metadata:
          type: object
          additionalProperties: true
          description: Arbitrary key-value metadata
          example:
            category: electronics
            priority: high
        createdAt:
          type: string
          format: date-time
          readOnly: true
          description: Creation timestamp (ISO 8601)
          example: '2024-01-15T10:30:00Z'
        updatedAt:
          type: string
          format: date-time
          readOnly: true
          description: Last update timestamp (ISO 8601)
          example: '2024-01-15T12:45:00Z'

    ItemCreate:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 255
          description: Name of the item
          example: My New Item
        description:
          type: string
          maxLength: 2000
          nullable: true
          description: Optional description
        status:
          $ref: '#/components/schemas/ItemStatus'
        metadata:
          type: object
          additionalProperties: true
          description: Arbitrary key-value metadata

    ItemUpdate:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 255
          description: Name of the item
        description:
          type: string
          maxLength: 2000
          nullable: true
          description: Optional description
        status:
          $ref: '#/components/schemas/ItemStatus'
        metadata:
          type: object
          additionalProperties: true
          description: Arbitrary key-value metadata

    ItemStatus:
      type: string
      enum:
        - draft
        - active
        - archived
      default: draft
      description: Current status of the item
      example: active

    ItemListResponse:
      type: object
      required:
        - data
        - pagination
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Item'
        pagination:
          $ref: '#/components/schemas/PaginationMeta'

    SubResourceListResponse:
      type: object
      required:
        - data
        - pagination
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/SubResource'
        pagination:
          $ref: '#/components/schemas/PaginationMeta'

    SubResource:
      type: object
      required:
        - id
        - itemId
        - name
      properties:
        id:
          type: string
          format: uuid
        itemId:
          type: string
          format: uuid
        name:
          type: string

    PaginationMeta:
      type: object
      required:
        - page
        - limit
        - totalItems
        - totalPages
      properties:
        page:
          type: integer
          description: Current page number
          example: 1
        limit:
          type: integer
          description: Items per page
          example: 20
        totalItems:
          type: integer
          description: Total number of items
          example: 100
        totalPages:
          type: integer
          description: Total number of pages
          example: 5
        hasNext:
          type: boolean
          description: Whether more pages exist
          example: true
        hasPrev:
          type: boolean
          description: Whether previous pages exist
          example: false

    Error:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
          description: Machine-readable error code
          example: VALIDATION_ERROR
        message:
          type: string
          description: Human-readable error message
          example: The request body is invalid
        details:
          type: array
          items:
            $ref: '#/components/schemas/ErrorDetail'
          description: Detailed error information
        requestId:
          type: string
          description: Unique request identifier for debugging
          example: req_abc123xyz

    ErrorDetail:
      type: object
      properties:
        field:
          type: string
          description: Field that caused the error
          example: name
        message:
          type: string
          description: Specific error message for this field
          example: Name is required
        code:
          type: string
          description: Error code for this specific issue
          example: REQUIRED

  responses:
    BadRequest:
      description: Bad request - invalid input
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            code: BAD_REQUEST
            message: Invalid request parameters
            requestId: req_abc123xyz

    Unauthorized:
      description: Unauthorized - authentication required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            code: UNAUTHORIZED
            message: Authentication required
            requestId: req_abc123xyz

    Forbidden:
      description: Forbidden - insufficient permissions
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            code: FORBIDDEN
            message: You do not have permission to access this resource
            requestId: req_abc123xyz

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            code: NOT_FOUND
            message: The requested resource was not found
            requestId: req_abc123xyz

    Conflict:
      description: Conflict - resource already exists
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            code: CONFLICT
            message: A resource with this identifier already exists
            requestId: req_abc123xyz

    UnprocessableEntity:
      description: Unprocessable entity - validation failed
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            code: VALIDATION_ERROR
            message: Validation failed
            details:
              - field: name
                message: Name must be between 1 and 255 characters
                code: LENGTH_OUT_OF_RANGE
            requestId: req_abc123xyz

    TooManyRequests:
      description: Rate limit exceeded
      headers:
        X-RateLimit-Limit:
          $ref: '#/components/headers/X-RateLimit-Limit'
        X-RateLimit-Remaining:
          $ref: '#/components/headers/X-RateLimit-Remaining'
        X-RateLimit-Reset:
          $ref: '#/components/headers/X-RateLimit-Reset'
        Retry-After:
          description: Seconds until rate limit resets
          schema:
            type: integer
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            code: RATE_LIMIT_EXCEEDED
            message: Too many requests. Please try again later.
            requestId: req_abc123xyz

    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            code: INTERNAL_ERROR
            message: An unexpected error occurred
            requestId: req_abc123xyz

security:
  - BearerAuth: []
